name: Universal GitOps Deployment

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'infra/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (optional)'
        required: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changed-services.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed services
        id: changed-services
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD -- apps/)
          SERVICES=$(echo "$CHANGED" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: [eu, us]
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    env:
      DEPLOY_DIR: /opt/gitops
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker context
        uses: docker/setup-buildx-action@v2

      - name: Deploy ${{ matrix.service }} to ${{ matrix.region }}
        uses: appleboy/ssh-action@master
        env:
          SSH_KEY: ${{ secrets[format('{0}_SSH_KEY', matrix.region)] }}
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.region)] }}
          username: ${{ secrets[format('{0}_USER', matrix.region)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.region)] }}
          script: |
            #!/bin/bash
            set -euo pipefail
            
            # Configurações
            SERVICE="${{ matrix.service }}"
            REGION="${{ matrix.region }}"
            LOG_FILE="/var/log/deployments/${SERVICE}-${REGION}.log"
            COMPOSE_FILE="${DEPLOY_DIR}/apps/${SERVICE}/docker-compose.yml"
            
            # Início do deploy
            echo "$(date) - Iniciando deploy do ${SERVICE} na ${REGION}" | tee -a ${LOG_FILE}
            
            cd ${DEPLOY_DIR}
            git pull origin main
            
            # Validar compose file
            docker-compose -f ${COMPOSE_FILE} config || {
              echo "Erro na validação do compose file" | tee -a ${LOG_FILE}
              exit 1
            }
            
            # Deploy com rollback automático
            docker stack deploy -c ${COMPOSE_FILE} ${SERVICE}-stack || {
              echo "Falha no deploy, realizando rollback..." | tee -a ${LOG_FILE}
              git checkout HEAD~1 -- ${COMPOSE_FILE}
              docker stack deploy -c ${COMPOSE_FILE} ${SERVICE}-stack
            }
            
            # Health check
            HEALTH_ENDPOINT=$(grep HEALTHCHECK ${COMPOSE_FILE} | cut -d'"' -f2)
            timeout 300 bash -c "while ! curl -sf ${HEALTH_ENDPOINT}; do 
              sleep 10
              echo 'Aguardando serviço...' | tee -a ${LOG_FILE}
            done" || {
              echo "Falha no health check após 5 minutos" | tee -a ${LOG_FILE}
              exit 1
            }
            
            echo "$(date) - Deploy concluído com sucesso" | tee -a ${LOG_FILE}

  post-deploy:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          STATUS: ${{ job.status }}